# WARNING - Generated by {fusen} from /dev/flat_performance_evaluation.Rmd: do not edit by hand

#' performance_eval_auto
#' 
#' Calculates diagnostic accuracy characteristics and generates report quality tables and figures. Executes multi_sen_spe_out_forest, multi_sen_spe_dt_out, and returns a list object with two forest plots and a DT data table for display.The function works with wide and long formats.
#' 
#' @return performance evaluation resuls as plots, formatted table, or simple data frame
#' 
#' @param data_var Data table containing tests results
#' @param list_index A list of index tests with "Negative" and "Positive" results. If the data is in long format, the name of the column where the results are stored.
#' @param ref The reference test with "Negative" and "Positive" results
#' @param conf.level The confidence level, 1-alpha â€“ default 95%
#' @param index_names An optional list containing names of the index tests. Not used with long data format.
#' @param forest_plot Should the forest plots be generated? Default TRUE
#' @param table_output Should a table output be generated? Default TRUE
#' @param data_long Is the data in the long format? Default FALSE
#' @param labels An optional text for the axis labels in forest plots.
#' @param file_name An optional text for the file name that will be available for download when the table output is generated
#' @param group_var The variable name where the groups are defined. Enter without quotation marks (e.g. ColName instead of "ColName"). Not used with wide data format.
#' 
#' @import ggplot2
#' @import plotly
#' @import DT
#' @import dplyr

#' 
#' @export
#' @examples
#' df <- data.frame(Index1 = c(rep("Positive", 20), rep("Negative", 20)), Index2 = c(rep("Positive", 5), rep("Negative", 35)), Index3 = c(rep("Positive", 9), rep("Negative", 31)), Reference = c(rep("Positive", 10), rep("Negative", 30)))
#' eval_output <- performance_eval_auto(data_var = df, list_index = c("Index1", "Index2", "Index3"), ref = "Reference", conf.level = 0.95, index_names = c("Tgs1", "AFD", "SimpleDx"), labels = "Test", forest_plot = TRUE, table_output = TRUE, file_name = "MyEvaluationExample")
#' eval_output$sen_plot
#' eval_output$spe_plot
#' eval_output$table
#' 
#' eval_output_only_forest <- performance_eval_auto(data_var = df, list_index = c("Index1", "Index2", "Index3"), ref = "Reference", conf.level = 0.95, index_names = c("Tgs1", "AFD", "SimpleDx"), labels = "Test", forest_plot = TRUE, table_output = FALSE)
#' eval_output_only_forest$sen_plot
#' eval_output_only_forest$spe_plot
#' eval_output_only_forest$table #NULL
#' 
#' eval_output_simple_df <- performance_eval_auto(data_var = df, list_index = c("Index1", "Index2", "Index3"), ref = "Reference", conf.level = 0.95, index_names = c("Tgs1", "AFD", "SimpleDx"), labels = "Test", forest_plot = FALSE, table_output = FALSE)
#' 
#' eval_output_simple_df
#' 
#' 
#' data(my_dataset)
#' head(my_dataset)
#' eval_output <- performance_eval_auto(data_var = my_dataset, list_index = "Result", ref = "RefTest", conf.level = 0.95, labels = "Test", forest_plot = FALSE, table_output = TRUE, file_name = "MyEvaluationExample", data_long = TRUE, group_var = Test_Name )
#' 
performance_eval_auto <- function(data_var, list_index, ref, conf.level = 0.95, index_names = NULL, labels = "Test", forest_plot = TRUE, table_output = TRUE, file_name = "performance_eval", data_long = FALSE,  group_var = NULL){
  if(data_long == FALSE & table_output == TRUE & forest_plot == FALSE){
    return_object <- multi_sen_spe_dt_out(data_var=data_var, list_index=list_index, ref=ref, conf.level = conf.level, index_names = index_names, file_name=file_name)
  } else if(data_long == FALSE & table_output == FALSE & forest_plot == TRUE){
    plots <- multi_sen_spe_out_forest(data_var = data_var, list_index = list_index, ref = ref, conf.level = conf.level, index_names = index_names, labels = labels)
    return_object <-  list("sen_plot" = plots[[1]], "spe_plot" = plots[[2]])
  } else if (data_long == FALSE & table_output == FALSE & forest_plot == FALSE) {
    return_object <- multi_sen_spe_forest(data_var = data_var, list_index = list_index, ref = ref, conf.level = conf.level, index_names = index_names)
  } else if (data_long == FALSE & table_output == TRUE & forest_plot == TRUE){
     plots <- multi_sen_spe_out_forest(data_var = data_var, list_index = list_index, ref = ref, conf.level = conf.level, index_names = index_names, labels = labels)
     dt_table <- multi_sen_spe_dt_out(data_var=data_var, list_index=list_index, ref=ref, conf.level = conf.level, index_names = index_names, file_name=file_name)
     return_object<- list("sen_plot" = plots[[1]], "spe_plot" = plots[[2]], "table" = dt_table)
  } else if(data_long == TRUE & table_output == TRUE & forest_plot == FALSE){
    long_table <- data_var %>% 
      group_by({{group_var}}) %>% 
      group_modify( ~ sens_spe( data_var = (.x), index = list_index,  ref = ref, conf.level = conf.level))
      colnames(long_table)[1] <- labels
      
      return_object <- datatable(long_table,
          extensions = 'Buttons',
                options = list(dom = 'Blfrtip',
                               buttons = list(
                                 list(extend = 'copy', filename = file_name),
                                 list(extend = 'csv', filename = file_name),
                                 list(extend = 'excel', filename = file_name),
                                 list(extend = 'pdf', filename = file_name)),
                               lengthMenu = list(c(10,-1),
                                                 c(10,"All"))))
      
  } else if(data_long == TRUE & table_output == FALSE & forest_plot == TRUE){
    long_table <- data_var %>% 
      group_by({{group_var}}) %>% 
      group_modify( ~ sens_spe_for_forest( data_var = (.x), index = list_index,  ref = ref, conf.level = conf.level))
      colnames(long_table)[1] <- "Test"
      
      fp_sen <- ggplot(data=long_table, aes(x=Test, y=Sensitivity, ymin=SensLower, ymax=SensUpper)) +
        geom_pointrange() + 
        coord_flip() +
        xlab(labels) + ylab("Sensitivity (95% CI)") +
        theme_classic() +
        scale_y_continuous(limits = c(0, 100),breaks = c(0, 20, 40, 60, 80, 100))+
        geom_point(size = 2, shape = 15)

      fp_spe <- ggplot(data=long_table, aes(x=Test, y=Specificity, ymin=SpeLower, ymax=SpeUpper)) +
        geom_pointrange() + 
        coord_flip() +
        xlab(labels) + ylab("Specificity (95% CI)") +
        theme_classic() +
        scale_y_continuous(limits = c(0, 100),breaks = c(0, 20, 40, 60, 80, 100))+
        geom_point(size = 2, shape = 15)

        return_object <-  list("sen_plot" =ggplotly(fp_sen), "spe_plot" = (fp_spe))
      
  } else if(data_long == TRUE & table_output == FALSE & forest_plot == FALSE) {
    return_object <- data_var %>% 
      group_by({{group_var}}) %>% 
      group_modify( ~ sens_spe_for_forest( data_var = (.x), index = list_index,  ref = ref, conf.level = conf.level))
      colnames(return_object)[1] <- "Test"
  } else if(data_long == TRUE & table_output == TRUE & forest_plot == TRUE){
    
  long_table <- data_var %>% 
      group_by({{group_var}}) %>% 
      group_modify( ~ sens_spe( data_var = (.x), index = list_index,  ref = ref, conf.level = conf.level))
      colnames(long_table)[1] <- labels
      
      dt_table <- datatable(long_table,
          extensions = 'Buttons',
                options = list(dom = 'Blfrtip',
                               buttons = list(
                                 list(extend = 'copy', filename = file_name),
                                 list(extend = 'csv', filename = file_name),
                                 list(extend = 'excel', filename = file_name),
                                 list(extend = 'pdf', filename = file_name)),
                               lengthMenu = list(c(10,-1),
                                                 c(10,"All"))))
      
      long_table <- data_var %>% 
      group_by({{group_var}}) %>% 
      group_modify( ~ sens_spe_for_forest( data_var = (.x), index = list_index,  ref = ref, conf.level = conf.level))
      colnames(long_table)[1] <- "Test"
      
      fp_sen <- ggplot(data=long_table, aes(x=Test, y=Sensitivity, ymin=SensLower, ymax=SensUpper)) +
        geom_pointrange() + 
        coord_flip() +
        xlab(labels) + ylab("Sensitivity (95% CI)") +
        theme_classic() +
        scale_y_continuous(limits = c(0, 100),breaks = c(0, 20, 40, 60, 80, 100))+
        geom_point(size = 2, shape = 15)

      fp_spe <- ggplot(data=long_table, aes(x=Test, y=Specificity, ymin=SpeLower, ymax=SpeUpper)) +
        geom_pointrange() + 
        coord_flip() +
        xlab(labels) + ylab("Specificity (95% CI)") +
        theme_classic() +
        scale_y_continuous(limits = c(0, 100),breaks = c(0, 20, 40, 60, 80, 100))+
        geom_point(size = 2, shape = 15)

        return_object <-  list("sen_plot" =ggplotly(fp_sen), "spe_plot" = (fp_spe), "table" = dt_table)
  
  }
  return(return_object)
}
