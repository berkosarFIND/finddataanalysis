# WARNING - Generated by {fusen} from /dev/flat_performance_evaluation.Rmd: do not edit by hand

#' Sensitivity and specificity (for forest plots)
#' 
#' Calculate sensitivity and specificity with confidence intervals from a data frame that contains the results of the index and the reference test. 
#' To be used for displaying the result in a forest plot.
#' 
#' @param data_var Data table containing test results
#' @param index The index test with "Negative" and "Positive" results
#' @param ref The reference test with "Negative" and "Positive" results
#' @param conf.level The confidence level, 1-alpha -- default 95%
#'
#' @return A data table with TP/FP/TN/FN, sensitivity, specificity and confidence intervals
#' @import dplyr
#' @import assertthat 
#' @import PropCIs
#' 
#' @export
#' @examples
#' library(forestplot)
#' library(dplyr)
#' df <- data.frame(Index = c(rep("Positive", 20), rep("Negative", 20)), Reference = c(rep("Positive", 30), rep("Negative", 10)))
#' forest_data <- cbind(Test = "Index", sens_spe_for_forest(data_var = df, index = "Index", ref = "Reference", conf.level = 0.95))
#' forest_data %>% forestplot(mean = Sensitivity, 
#'                           lower = SensLower, 
#'                           upper = SensUpper, 
#'                           labeltext = Test,
#'                           title = "Sensitivity",
#'                           zero = NA,
#'                           xticks = c( 0, 20, 40, 60, 80, 100),
#'                           txt_gp = fpTxtGp(ticks=gpar(cex=1)),
#'                           boxsize = .1
#'                           )
sens_spe_for_forest <- function(data_var, index, ref, conf.level = 0.95){
  #verify that these are column names in characters
  assert_that(is.character(index))
  assert_that(is.character(ref))

  # Calculate number of TP, TN, FP, FN, etc.
  TP	<- nrow(data_var[which(data_var[,index] == "Positive" & data_var[,ref] == "Positive"),])
  FP	<- nrow(data_var[which(data_var[,index] == "Positive" & data_var[,ref] == "Negative"),])
  FN	<- nrow(data_var[which(data_var[,index] == "Negative" & data_var[,ref] == "Positive"),])
  TN	<- nrow(data_var[which(data_var[,index] == "Negative" & data_var[,ref] == "Negative"),])

  sens	<- round((TP / (TP + FN))*100, 2)
  sens_CI	<- scoreci(x = TP, n  = (TP + FN), conf.level = conf.level)

  spe		<- round((TN / (TN +FP))*100,2)
  spe_CI	<- scoreci(x = TN, n  = (TN + FP), conf.level = conf.level)
  BA <- round((sens+spe)/2, 2)
  BA_lci <- round((sens_CI$conf.int[1]*100 + spe_CI$conf.int[1]*100)/2, 2)
  BA_hci <- round((sens_CI$conf.int[2]*100 + spe_CI$conf.int[2]*100)/2, 2)
  DOR <- round((TP*TN)/(FP*FN), 2)
  se_dor <- sqrt((1/TP+1/FN+1/FP+1/TN))
  z <- qnorm(1-conf.level/2) 
  DOR_lci <- round(exp(log(DOR) - z*se_dor), 2)
  DOR_hci <- round(exp(log(DOR) + z*se_dor), 2)

  PPV	<- round((TP / (TP + FP))*100, 2)
  ppv_CI	<- scoreci(x = TP, n  = (TP + FP), conf.level = conf.level)
  NPV	<- round((TN / (TN + FN))*100,2)
  npv_CI	<- scoreci(x = TN, n  = (TN + FN), conf.level = conf.level)

  ACC	<- round(((TP + TN) / (TP + FP + FN + TN))*100,2)
  acc_CI	<- scoreci(x = (TP + TN), n  = (TP + FP + FN + TN), conf.level = conf.level)

  N 		<- TP + TN + FP + FN

  data_to_return_1	<- data.frame(N = N, TP = TP, FP = FP, FN = FN, TN = TN,
                                 Sensitivity = sens, Specificity = (spe),
                                 SensLower = (sens_CI$conf.int[1])*100,
                                 SensUpper = (sens_CI$conf.int[2])*100,
                                 SpeLower = (spe_CI$conf.int[1])*100,
                                 SpeUpper = (spe_CI$conf.int[2])*100,
                                 Balanced_Accuracy = BA,
                                 BAlower = BA_lci,
                                 BAupper = BA_hci,
                                 DOR = DOR,
                                 DORUpper = DOR_hci,
                                 DORLower = DOR_lci,
                                 PPV = PPV,
                                 PPVLower = (ppv_CI$conf.int[1])*100,
                                 PPVUpper = (ppv_CI$conf.int[2])*100,
                                 NPV = NPV,
                                 NPVLower = (npv_CI$conf.int[1])*100,
                                 NPVUpper = (npv_CI$conf.int[2])*100,
                                 Accuracy = ACC,
                                 ACCLower = (acc_CI$conf.int[1])*100,
                                 ACCUpper = (acc_CI$conf.int[2])*100)
  return(data_to_return_1)
}




